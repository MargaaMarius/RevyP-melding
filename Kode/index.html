<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adminside for påmelding til Ski-Revyen 2020</title>
    <link rel="stylesheet"
          type="text/css"
          href="RevyP-meldingCSS.css">
</head>
<body>
<header></header>
<main>
  <article id="registrerGruppe">
    <form id="registrerGruppeSkjema" onsubmit="regGruppe(event)">
      <label>Gruppenavn:<input type="text" required id="inpGruppeNavn"></label>
      <button type="submit">Registrer gruppe</button>
    </form>
  </article>
  <article id="visEleverArt">
    <table>
      <thead>
        <th>Navn</th>
        <th>Klasse</th>
        <th>E-mail</th>
        <th>Telefonnummer</th>
        <th>1. Valg</th>
        <th>2. Valg</th>
        <th>3. Valg</th>
        <th>Kommentar</th>
        <th></th>
      </thead>
      <tbody id ="visEleverTabell"></tbody>
    </table>
  </article>
</main>
<footer></footer>
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#config-web-app -->

<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-database.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyAjzup6aViAjPSMj8U1WWAZ03TjoizZBOw",
    authDomain: "revypaameliding.firebaseapp.com",
    databaseURL: "https://revypaameliding.firebaseio.com",
    projectId: "revypaameliding",
    storageBucket: "revypaameliding.appspot.com",
    messagingSenderId: "631148301638",
    appId: "1:631148301638:web:03704743bf07a350"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
</script>
<script>
  let db = firebase.database();
  let grupper = db.ref("grupper");
  let elever = db.ref("elever");
  let tabellID = "";
  let inpGruppeNavn = document.getElementById("inpGruppeNavn");
  let gruppeSkjema = document.getElementById("registrerGruppeSkjema");
  let alleEleverVis = document.getElementById("visEleverTabell");
  let tabellArticle = document.getElementById("visEleverArt");

  //Lar admin registrere en gruppe
  function regGruppe(event) {
    event.preventDefault();
    grupper.push({
      "navn": inpGruppeNavn.value,
    });
    gruppeSkjema.reset();
  }

  //Viser elevene som har meldt seg på
  function hentElever(snapshot) {
    let tabellIDF = tabellID;
    let tabell = document.getElementById(tabellIDF);
    let elevVis = snapshot.val();
    let elevVisKey = snapshot.key;
    let valg1ref = db.ref("grupper/" + elevVis.Valg1);
    valg1ref.once("value", function (snapshotV1) {
      let valg1obj = snapshotV1.val();
      let valg2ref = db.ref("grupper/" + elevVis.Valg2);
      valg2ref.once("value", function (snapshotV2) {
        let valg2obj = snapshotV2.val();
        let valg3ref = db.ref("grupper/" + elevVis.Valg3);
        valg3ref.once("value", function (snapshotV3) {
          let valg3obj = snapshotV3.val();
          tabell.innerHTML += `
           <tr>
            <td>${elevVis.navn}</td>
            <td>${elevVis.klasse}</td>
            <td>${elevVis.epost}</td>
            <td>${elevVis.tlf}</td>
            <td>${valg1obj.navn}</td>
            <td>${valg2obj.navn}</td>
            <td>${valg3obj.navn}</td>
            <td>${elevVis.kommentar}</td>
            <td>
              <form onsubmit="flyttElevFor(event, '${elevVisKey}')">
                <select id="velgGruppe${tabellIDF}${elevVisKey}(${elevVis.navn})">
                  <option>Legg til i en gruppe</option>
                  <option value="slett">Slett elev</option>
                  <option value="fjern">Fjern fra gruppen</option>
                </select>
                <button type="submit">OK</button>
               </form>
             </td>
          </tr>
          `;
            grupper.on("child_added", function (gruppesnapshot) {
              let gruppeValgSelect = document.getElementById("velgGruppe" + tabellIDF + elevVisKey + "(" + elevVis.navn + ")");
              let gruppeValg = gruppesnapshot.val();
              let gruppeValgKey = gruppesnapshot.key;
              switch (gruppeValgKey) {
                case elevVis.Valg1:
                  gruppeValgSelect.innerHTML += `
                <option value="${gruppeValgKey}">${gruppeValg.navn} (1. Valg)</option>
                `;
                  console.log("hei");
                  break;
                case elevVis.Valg2:
                  gruppeValgSelect.innerHTML += `
                <option value="${gruppeValgKey}">${gruppeValg.navn} (2. Valg)</option>
                `;
                  break;
                case elevVis.Valg3:
                  gruppeValgSelect.innerHTML += `
                <option value="${gruppeValgKey}">${gruppeValg.navn} (3. Valg)</option>
                `;
                  break;
                default:
                  gruppeValgSelect.innerHTML += `
                <option value="${gruppeValgKey}">${gruppeValg.navn}</option>
                `;
                  break;
              }
            });
          })
        });
      });
    }

  //Lager en tabell for hver gruppe der medlemmer og antall vises
  function visGruppeTabeller(snapshot){
    let gruppeVisTab = snapshot.val();
    let gruppeVisTabKey = snapshot.key;
    let gruppeAntall = 0;
    tabellArticle.innerHTML += `
    <p>${gruppeVisTab.navn}</p>
    <p id="Antall${gruppeVisTabKey}">Antall: ${gruppeAntall}</p>
    <table>
      <thead>
      <th>Navn</th>
      <th>Klasse</th>
      <th>E-post</th>
      <th>Telefonnummer</th>
      <th>1.Valg</th>
      <th>2.Valg</th>
      <th>3.Valg</th>
      <th>Kommentar</th>
      <th>Endre/Fjern</th>
      </thead>
      <tbody id="tabellFor${gruppeVisTabKey}(${gruppeVisTab.navn})">
      </tbody>
    </table>
    `;
    tabellID = "tabellFor"+gruppeVisTabKey+"("+gruppeVisTab.navn+")";
    elever.orderByChild("gruppe")
      .equalTo(gruppeVisTabKey)
      .on("child_added", hentElever);
  }

  //Funksjon som lytter på en innsending av et av skjemaene som lar admin fjerne/fjerne fra en gruppe/legge til i en gruppe
  function flyttElev(event, elevFlyttKey, gruppeFjernKey){
    event.preventDefault();
    let elevFlyttSelelct = document.getElementById("velgGruppe"+elevFlyttKey+"("+elevFlytt.navn+")");
    let elevObj = db.ref("elever/"+elevFlyttKey);
    switch(elevFlyttSelelct){
      case "slett":
        elevObj.remove();
        break;
      case "fjern":
        elevObjData = {
          "gruppe": "NA"
        };
        elevObj.update(elevObjData);
        break;
      default:
        elevObj.once("value", function(snapshot){
          let elevFlytt = snapshot.val();
          let elevFlyttSelelct = document.getElementById("velgGruppe"+elevFlyttKey+"("+elevFlytt.navn+")");
          let elevFlyttObj = elever.child(elevFlyttKey);
          let elevFlyttData = {
            "gruppe" : elevFlyttSelelct.value
          };
          elevFlyttObj.update(elevFlyttData);
          alleEleverVis.innerHTML = ``;
          hentAlleElever();
          grupper.on("child_added", visGruppeTabeller);
        });
        break;
    }
  }

  function hentAlleElever(){
    tabellID = "visEleverTabell";
    elever.on("child_added", hentElever);
  }

  hentAlleElever();
  grupper.on("child_added", visGruppeTabeller);
</script>
</body>
</html>
