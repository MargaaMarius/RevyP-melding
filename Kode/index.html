<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adminside for påmelding til Ski-Revyen 2020</title>
    <link rel="stylesheet"
          type="text/css"
          href="RevyP-meldingCSS.css">
</head>
<body>
<header></header>
<main>
  <article id="registrerGruppe">
    <form id="registrerGruppeSkjema" onsubmit="regGruppe(event)">
      <label>Gruppenavn:<input type="text" required id="inpGruppeNavn"></label>
      <button type="submit">Registrer gruppe</button>
    </form>
  </article>
  <article id="visEleverArt">
    <table>
      <thead>
        <th><button onclick="sorterTabell(event, 'visEleverTabell', 'navn')">Navn</button></th>
        <th><button onclick="sorterTabell(event, 'visEleverTabell', 'klasse')">Klasse</button></th>
        <th><button onclick="sorterTabell(event, 'visEleverTabell', 'epost')">E-Mail</button></th>
        <th><button onclick="sorterTabell(event, 'visEleverTabell', 'tlf')">Telefonnummer</button></th>
        <th><button>1.Valg</button></th>
        <th><button>2.Valg</button></th>
        <th><button>3.Valg</button></th>
        <th><button onclick="sorterTabell(event, 'visEleverArt', 'kommentar')">Kommentar</button></th>
        <th></th>
      </thead>
      <tbody id ="visEleverTabell" class="elevTabell"></tbody>
    </table>
  </article>
</main>
<footer></footer>
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#config-web-app -->

<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-database.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyAjzup6aViAjPSMj8U1WWAZ03TjoizZBOw",
    authDomain: "revypaameliding.firebaseapp.com",
    databaseURL: "https://revypaameliding.firebaseio.com",
    projectId: "revypaameliding",
    storageBucket: "revypaameliding.appspot.com",
    messagingSenderId: "631148301638",
    appId: "1:631148301638:web:03704743bf07a350"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
</script>
<script>
  let db = firebase.database();
  let grupper = db.ref("grupper");
  let elever = db.ref("elever");
  let tabellID = "";
  let inpGruppeNavn = document.getElementById("inpGruppeNavn");
  let gruppeSkjema = document.getElementById("registrerGruppeSkjema");
  let alleEleverVis = document.getElementById("visEleverTabell");
  let tabellArticle = document.getElementById("visEleverArt");

  //Lar admin registrere en gruppe
  function regGruppe(event) {
    event.preventDefault();
    grupper.push({
      "navn": inpGruppeNavn.value,
    });
    gruppeSkjema.reset();
  }

  //Viser elevene som har meldt seg på
  function hentElever(snapshot) {
    let tabellIDF = tabellID;
    let tabell = document.getElementById(tabellIDF);
    let elevVis = snapshot.val();
    let elevVisKey = snapshot.key;
    let valg1ref = db.ref("grupper/" + elevVis.Valg1);
    valg1ref.once("value", function (snapshotV1) {
      let valg1obj = snapshotV1.val();
      let valg2ref = db.ref("grupper/" + elevVis.Valg2);
      valg2ref.once("value", function (snapshotV2) {
        let valg2obj = snapshotV2.val();
        let valg3ref = db.ref("grupper/" + elevVis.Valg3);
        valg3ref.once("value", function (snapshotV3) {
          let valg3obj = snapshotV3.val();
          tabell.innerHTML += `
           <tr>
            <td>${elevVis.navn}</td>
            <td>${elevVis.klasse}</td>
            <td>${elevVis.epost}</td>
            <td>${elevVis.tlf}</td>
            <td>${valg1obj.navn}</td>
            <td>${valg2obj.navn}</td>
            <td>${valg3obj.navn}</td>
            <td>${elevVis.kommentar}</td>
            <td>
              <form onsubmit="flyttElev(event, '${elevVisKey}', '${tabellIDF}')">
                <select id="velgGruppe${tabellIDF}${elevVisKey}(${elevVis.navn})">
                  <option>Legg til i en gruppe</option>
                  <option value="slett">Slett elev</option>
                  <option value="fjern">Fjern fra gruppen</option>
                </select>
                <button type="submit">OK</button>
               </form>
             </td>
          </tr>
          `;
            grupper.on("child_added", function (gruppesnapshot) {
              let gruppeValgSelect = document.getElementById("velgGruppe" + tabellIDF + elevVisKey + "(" + elevVis.navn + ")");
              let gruppeValg = gruppesnapshot.val();
              let gruppeValgKey = gruppesnapshot.key;
              switch (gruppeValgKey) {
                case elevVis.Valg1:
                  gruppeValgSelect.innerHTML += `
                <option value="${gruppeValgKey}">${gruppeValg.navn} (1. Valg)</option>
                `;
                  break;
                case elevVis.Valg2:
                  gruppeValgSelect.innerHTML += `
                <option value="${gruppeValgKey}">${gruppeValg.navn} (2. Valg)</option>
                `;
                  break;
                case elevVis.Valg3:
                  gruppeValgSelect.innerHTML += `
                <option value="${gruppeValgKey}">${gruppeValg.navn} (3. Valg)</option>
                `;
                  break;
                default:
                  gruppeValgSelect.innerHTML += `
                <option value="${gruppeValgKey}">${gruppeValg.navn}</option>
                `;
                  break;
              }
            });
          })
        });
      });
    }

  //Lager en tabell for hver gruppe der medlemmer og antall vises
  function visGruppeTabeller(snapshot){
    let gruppeVisTab = snapshot.val();
    let gruppeVisTabKey = snapshot.key;
    let gruppeAntall = 0;
    tabellArticle.innerHTML += `
    <article class="gruppeArticle">
      <p>${gruppeVisTab.navn}</p>
      <p  id="Antall${gruppeVisTabKey}">Antall: ${gruppeAntall}</p>
      <table>
        <thead>
          <th><button onclick="sorterTabell(event, 'tabellFor${gruppeVisTabKey}(${gruppeVisTab.navn})', 'navn')">Navn</button></th>
          <th><button onclick="sorterTabell(event, 'tabellFor${gruppeVisTabKey}(${gruppeVisTab.navn})', 'klasse')">Klasse</button></th>
          <th><button onclick="sorterTabell(event, 'tabellFor${gruppeVisTabKey}(${gruppeVisTab.navn})', 'epost')">E-mail</button></th>
          <th><button onclick="sorterTabell(event, 'tabellFor${gruppeVisTabKey}(${gruppeVisTab.navn})', 'tlf')">Telefonnummer</button></th>
          <th><button>1.Valg</button></th>
          <th><button>2.Valg</button></th>
          <th><button>3.Valg</button></th>
          <th><button onclick="sorterTabell(event, 'tabellFor${gruppeVisTabKey}(${gruppeVisTab.navn})', 'kommentar')">Kommentar</button></th>
          <th></th>
        </thead>
        <tbody id="tabellFor${gruppeVisTabKey}(${gruppeVisTab.navn})" class="elevTabell">
        </tbody>
      </table>
    </article>
    `;
    tabellID = "tabellFor"+gruppeVisTabKey+"("+gruppeVisTab.navn+")";
    elever.orderByChild("gruppe")
      .equalTo(gruppeVisTabKey)
      .on("child_added", hentElever);
  }

  //Funksjon som lytter på en innsending av et av skjemaene som lar admin fjerne/fjerne fra en gruppe/legge til i en gruppe
  function flyttElev(event, elevFlyttKey, tabellIDF) {
    event.preventDefault();
    let elevObj = db.ref("elever/" + elevFlyttKey);
    elevObj.once("value", function (snapshot) {
      let elevFlytt = snapshot.val();
      let elevFlyttSelect = document.getElementById("velgGruppe" + tabellIDF + elevFlyttKey + "(" + elevFlytt.navn + ")");
      switch (elevFlyttSelect.value) {
        case "slett":
          elevObj.remove();
          hentAlleElever();
          break;
        case "fjern":
          elevObjData = {
            "gruppe": "NA"
          };
          elevObj.update(elevObjData);
          hentAlleElever();
          break;
        default:
          let elevFlyttObj = elever.child(elevFlyttKey);
          let elevFlyttData = {
            "gruppe": elevFlyttSelect.value
          };
          elevFlyttObj.update(elevFlyttData);
          alleEleverVis.innerHTML = ``;
          hentAlleElever();
          break;
      }
    });
  }

  //henter alle elever til alle tabeller. Tømmer først alle tabeller, så fyller dem
  function hentAlleElever(){
    tabellID = "visEleverTabell";
    let alleTabeller = document.getElementsByClassName("elevTabell");
    let antallTabeller = alleTabeller.length;
    for (i=0;i<antallTabeller;i++){
      alleTabeller[i].innerHTML = ``;
    }
    elever.on("child_added", hentElever);
    grupper.on("child_added", visGruppeTabeller);
  }

  //Sorterer tabellene
  function sorterTabell (event, tabell, egenskap){
    event.preventDefault();
    tabellID = tabell;
    let sorterTabell = document.getElementById(tabell);
    sorterTabell.innerHTML = ``;
    elever.orderByChild(egenskap).on("child_added",  hentElever);
  }

  hentAlleElever();
</script>
</body>
</html>
